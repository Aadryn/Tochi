# TÃ¢che 067.2 - Infrastructure Authorization PostgreSQL

## PRIORITÃ‰
ðŸ”´ **P1 - CRITIQUE** (DÃ©pend de 067.1)

## OBJECTIF

CrÃ©er la couche Infrastructure PostgreSQL pour le systÃ¨me d'autorisation :
- Migrations Entity Framework pour les tables
- Repositories pour Principal, RoleDefinition, RoleAssignment
- Configuration EF Core

## IMPLÃ‰MENTATION

### Structure de Fichiers

```
src/Infrastructure/LLMProxy.Infrastructure.Authorization.PostgreSQL/
â”œâ”€â”€ LLMProxy.Infrastructure.Authorization.PostgreSQL.csproj
â”œâ”€â”€ AuthorizationDbContext.cs
â”œâ”€â”€ Configurations/
â”‚   â”œâ”€â”€ PrincipalConfiguration.cs
â”‚   â”œâ”€â”€ GroupConfiguration.cs
â”‚   â”œâ”€â”€ GroupMemberConfiguration.cs
â”‚   â”œâ”€â”€ RoleDefinitionConfiguration.cs
â”‚   â””â”€â”€ RoleAssignmentConfiguration.cs
â”œâ”€â”€ Repositories/
â”‚   â”œâ”€â”€ PrincipalRepository.cs
â”‚   â”œâ”€â”€ RoleDefinitionRepository.cs
â”‚   â””â”€â”€ RoleAssignmentRepository.cs
â”œâ”€â”€ Migrations/
â”‚   â””â”€â”€ (auto-generated)
â”œâ”€â”€ Seeds/
â”‚   â””â”€â”€ BuiltInRolesSeeder.cs
â””â”€â”€ Extensions/
    â””â”€â”€ ServiceCollectionExtensions.cs
```

### SchÃ©ma de Base de DonnÃ©es

**PRINCIPE CLÃ‰** : La colonne `id` (UUID) est l'**ObjectId** - l'identifiant primaire unique de chaque principal.

```sql
-- Table des principals (users, groups, service accounts)
-- id = ObjectId (GUID) : identifiant primaire unique
-- external_id = identifiant IDP (email, nom) pour synchronisation
CREATE TABLE authorization.principals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),  -- ObjectId
    type VARCHAR(20) NOT NULL CHECK (type IN ('user', 'group', 'service_account')),
    external_id VARCHAR(255) NOT NULL,  -- Email/nom pour sync IDP uniquement
    display_name VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    CONSTRAINT uq_principals_external_id UNIQUE (type, external_id)
);

-- Index pour recherche rapide
CREATE INDEX idx_principals_type ON authorization.principals(type);
CREATE INDEX idx_principals_email ON authorization.principals(email) WHERE email IS NOT NULL;

-- Table des membres de groupe (relation N:N rÃ©cursive)
CREATE TABLE authorization.group_members (
    group_id UUID NOT NULL REFERENCES authorization.principals(id) ON DELETE CASCADE,
    member_id UUID NOT NULL REFERENCES authorization.principals(id) ON DELETE CASCADE,
    added_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    added_by UUID REFERENCES authorization.principals(id),
    PRIMARY KEY (group_id, member_id),
    CONSTRAINT chk_no_self_membership CHECK (group_id != member_id)
);

-- Index pour lookup rapide des groupes d'un membre
CREATE INDEX idx_group_members_member ON authorization.group_members(member_id);

-- Table des dÃ©finitions de rÃ´les
CREATE TABLE authorization.role_definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    is_builtin BOOLEAN NOT NULL DEFAULT FALSE,
    permissions JSONB NOT NULL DEFAULT '[]',
    assignable_scopes JSONB NOT NULL DEFAULT '["platform", "organization", "tenant", "resource"]',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ,
    created_by UUID REFERENCES authorization.principals(id)
);

-- Index pour recherche par nom
CREATE INDEX idx_role_definitions_name ON authorization.role_definitions(name);

-- Table des attributions de rÃ´les
CREATE TABLE authorization.role_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    principal_id UUID NOT NULL REFERENCES authorization.principals(id) ON DELETE CASCADE,
    role_definition_id UUID NOT NULL REFERENCES authorization.role_definitions(id) ON DELETE CASCADE,
    scope_type VARCHAR(20) NOT NULL CHECK (scope_type IN ('platform', 'organization', 'tenant', 'resource')),
    scope_id VARCHAR(255) NOT NULL,
    scope_resource_type VARCHAR(50),  -- Null sauf pour scope_type = 'resource'
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_by UUID REFERENCES authorization.principals(id),
    expires_at TIMESTAMPTZ,
    condition JSONB,
    CONSTRAINT uq_role_assignments UNIQUE (principal_id, role_definition_id, scope_type, scope_id)
);

-- Index pour recherche d'assignments
CREATE INDEX idx_role_assignments_principal ON authorization.role_assignments(principal_id);
CREATE INDEX idx_role_assignments_scope ON authorization.role_assignments(scope_type, scope_id);
CREATE INDEX idx_role_assignments_expires ON authorization.role_assignments(expires_at) WHERE expires_at IS NOT NULL;
```

### RÃ´les PrÃ©dÃ©finis (Seed)

```csharp
public static class BuiltInRoles
{
    public static readonly RoleDefinition PlatformAdmin = new(
        name: "Platform.Admin",
        description: "Super-administrateur avec accÃ¨s complet Ã  la plateforme",
        permissions: new[] { new Permission("*", "*") },
        assignableScopes: new[] { ScopeType.Platform }
    );
    
    public static readonly RoleDefinition OrganizationOwner = new(
        name: "Organization.Owner",
        description: "PropriÃ©taire d'organisation avec tous les droits",
        permissions: new[] { new Permission("*", "*") },
        assignableScopes: new[] { ScopeType.Organization }
    );
    
    // ... autres rÃ´les prÃ©dÃ©finis
    
    public static IEnumerable<RoleDefinition> All => new[]
    {
        PlatformAdmin,
        OrganizationOwner,
        OrganizationAdmin,
        TenantOwner,
        TenantAdmin,
        TenantOperator,
        TenantReader,
        ProviderUser,
        ApiKeyOwner
    };
}
```

## CRITÃˆRES DE SUCCÃˆS

- [ ] Schema PostgreSQL crÃ©Ã© dans namespace `authorization`
- [ ] Entity Framework configurations complÃ¨tes
- [ ] Repositories implÃ©mentÃ©s avec cache
- [ ] 9 rÃ´les prÃ©dÃ©finis seedÃ©s
- [ ] Migrations EF Core fonctionnelles
- [ ] Tests d'intÃ©gration avec TestContainers
- [ ] Documentation XML complÃ¨te
- [ ] Build : 0 erreurs, 0 warnings

## ESTIMATION

**Effort** : 8h
**ComplexitÃ©** : Moyenne-Haute

## DÃ‰PENDANCES

- 067.1 (Domain Layer) doit Ãªtre complÃ©tÃ©

## TRACKING
