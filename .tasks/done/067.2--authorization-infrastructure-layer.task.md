# TÃ¢che 067.2 - Authorization Infrastructure Layer (OpenFGA + Redis + PostgreSQL Audit)

## PRIORITÃ‰
ğŸŸ  **P2 - HAUTE** (DÃ©pend de 067.1)

## OBJECTIF

ImplÃ©menter l'infrastructure pour l'application Authorization :
- **OpenFGA** : Source de vÃ©ritÃ© autorisations (1 store par tenant - Multi-tenant)
- **Redis** : Cache des rÃ©sultats de Check (performance)
- **PostgreSQL** : Audit trail uniquement (table dÃ©diÃ©e)

**Architecture Multi-tenant** : Un store OpenFGA par tenant pour isolation complÃ¨te.

## DÃ‰PENDANCES

- âœ… **067.1** - Domain Layer (DTOs, Value Objects)

## ARCHITECTURE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Authorization.Infrastructure                   â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                 OpenFGA Service (Multi-Tenant)            â”‚  â”‚
â”‚   â”‚                                                           â”‚  â”‚
â”‚   â”‚  - 1 Store par Tenant (isolation complÃ¨te)               â”‚  â”‚
â”‚   â”‚  - WriteTuples (assignments, memberships, hierarchy)      â”‚  â”‚
â”‚   â”‚  - DeleteTuples (revoke) â†’ RÃ©vocation immÃ©diate          â”‚  â”‚
â”‚   â”‚  - Check (permission verification)                       â”‚  â”‚
â”‚   â”‚  - ListObjects (list resources with permission)          â”‚  â”‚
â”‚   â”‚  - Read (get tuples)                                     â”‚  â”‚
â”‚   â”‚  - Custom Roles support                                  â”‚  â”‚
â”‚   â”‚  - Granular Permissions (resource:action)                â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                    Redis Cache                            â”‚  â”‚
â”‚   â”‚                                                           â”‚  â”‚
â”‚   â”‚  - Check results (TTL 5min)                              â”‚  â”‚
â”‚   â”‚  - ListObjects results (TTL 1min)                        â”‚  â”‚
â”‚   â”‚  - Invalidation on Write/Delete                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                  PostgreSQL (Audit Only)                  â”‚  â”‚
â”‚   â”‚                                                           â”‚  â”‚
â”‚   â”‚  - authorization_audit table                             â”‚  â”‚
â”‚   â”‚  - Operations: ASSIGN, REVOKE, CREATE_SCOPE, etc.        â”‚  â”‚
â”‚   â”‚  - Correlation ID pour traÃ§abilitÃ©                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## STRUCTURE DE FICHIERS

```
authorization/src/Authorization.Infrastructure/
â”œâ”€â”€ Authorization.Infrastructure.csproj
â”œâ”€â”€ DependencyInjection.cs
â”œâ”€â”€ OpenFga/
â”‚   â”œâ”€â”€ IOpenFgaService.cs
â”‚   â”œâ”€â”€ OpenFgaService.cs
â”‚   â”œâ”€â”€ OpenFgaConfiguration.cs
â”‚   â”œâ”€â”€ TupleBuilder.cs
â”‚   â””â”€â”€ TenantStoreResolver.cs       # Multi-tenant store resolution
â”œâ”€â”€ Caching/
â”‚   â”œâ”€â”€ IPermissionCache.cs
â”‚   â”œâ”€â”€ PermissionCacheService.cs
â”‚   â””â”€â”€ CacheKeys.cs
â”œâ”€â”€ Audit/
â”‚   â”œâ”€â”€ IAuditRepository.cs
â”‚   â”œâ”€â”€ AuditRepository.cs
â”‚   â”œâ”€â”€ AuditDbContext.cs
â”‚   â””â”€â”€ Models/
â”‚       â””â”€â”€ AuditEntry.cs
â””â”€â”€ Health/
    â”œâ”€â”€ OpenFgaHealthCheck.cs
    â””â”€â”€ AuditDbHealthCheck.cs

authorization/infrastructure/openfga/
â”œâ”€â”€ authorization-model.fga          # ModÃ¨le d'autorisation (enrichi)
â”œâ”€â”€ store-config.json                # Configuration du store
â””â”€â”€ seed-data.json                   # DonnÃ©es initiales (dev)

authorization/infrastructure/migrations/
â””â”€â”€ 001_create_audit_table.sql       # Migration table audit
```

## IMPLÃ‰MENTATION

### 1. OpenFGA Configuration

```csharp
// OpenFga/OpenFgaConfiguration.cs
public sealed class OpenFgaConfiguration
{
    public required string ApiUrl { get; init; }
    public required string StoreId { get; init; }
    public string? AuthorizationModelId { get; init; }
    public TimeSpan Timeout { get; init; } = TimeSpan.FromSeconds(5);
}
```

### 2. Interface OpenFGA Service

```csharp
// OpenFga/IOpenFgaService.cs
public interface IOpenFgaService
{
    // Check permission
    Task<bool> CheckAsync(
        string user,
        string relation,
        string @object,
        CancellationToken ct = default);
    
    // Write tuples (assignments, memberships, hierarchy)
    Task WriteTuplesAsync(
        IEnumerable<TupleKey> tuples,
        CancellationToken ct = default);
    
    // Delete tuples
    Task DeleteTuplesAsync(
        IEnumerable<TupleKey> tuples,
        CancellationToken ct = default);
    
    // List objects with permission
    Task<IReadOnlyList<string>> ListObjectsAsync(
        string user,
        string relation,
        string type,
        CancellationToken ct = default);
    
    // Read tuples
    Task<IReadOnlyList<TupleKey>> ReadAsync(
        string? user = null,
        string? relation = null,
        string? @object = null,
        CancellationToken ct = default);
    
    // Expand relation (debug)
    Task<ExpandResult> ExpandAsync(
        string relation,
        string @object,
        CancellationToken ct = default);
}
```

### 3. TupleBuilder (FaÃ§ade simplifiÃ©e)

```csharp
// OpenFga/TupleBuilder.cs
public static class TupleBuilder
{
    // User assignment
    public static TupleKey UserAssignment(Guid userId, string role, Scope scope)
        => new($"user:{userId}", role, $"scope:{scope.Path}");
    
    // Group assignment
    public static TupleKey GroupAssignment(Guid groupId, string role, Scope scope)
        => new($"group:{groupId}#member", role, $"scope:{scope.Path}");
    
    // Group membership
    public static TupleKey GroupMembership(Guid userId, Guid groupId)
        => new($"user:{userId}", "member", $"group:{groupId}");
    
    // Scope hierarchy (child â†’ parent)
    public static TupleKey ScopeParent(Scope child, Scope parent)
        => new($"scope:{child.Path}", "parent", $"scope:{parent.Path}");
}
```

### 4. Cache Service

```csharp
// Caching/IPermissionCache.cs
public interface IPermissionCache
{
    Task<bool?> GetCheckResultAsync(
        string user, string relation, string @object,
        CancellationToken ct = default);
    
    Task SetCheckResultAsync(
        string user, string relation, string @object,
        bool allowed, TimeSpan ttl,
        CancellationToken ct = default);
    
    Task InvalidateUserAsync(string user, CancellationToken ct = default);
    Task InvalidateObjectAsync(string @object, CancellationToken ct = default);
}
```

### 5. Dependency Injection

```csharp
// DependencyInjection.cs
public static class DependencyInjection
{
    public static IServiceCollection AddAuthorizationInfrastructure(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        // OpenFGA
        services.Configure<OpenFgaConfiguration>(
            configuration.GetSection("OpenFga"));
        
        services.AddSingleton<OpenFgaClient>(sp =>
        {
            var config = sp.GetRequiredService<IOptions<OpenFgaConfiguration>>().Value;
            return new OpenFgaClient(new ClientConfiguration
            {
                ApiUrl = config.ApiUrl,
                StoreId = config.StoreId,
                AuthorizationModelId = config.AuthorizationModelId
            });
        });
        
        services.AddScoped<IOpenFgaService, OpenFgaService>();
        
        // Redis Cache
        services.AddStackExchangeRedisCache(options =>
        {
            options.Configuration = configuration.GetConnectionString("Redis");
            options.InstanceName = "authz:";
        });
        
        services.AddScoped<IPermissionCache, PermissionCacheService>();
        
        // Health Checks
        services.AddHealthChecks()
            .AddCheck<OpenFgaHealthCheck>("openfga");
        
        return services;
    }
}
```

## MODÃˆLE OPENFGA (Enrichi)

Fichier : `authorization/infrastructure/openfga/authorization-model.fga`

```fga
model
  schema 1.1

type user

type group
  relations
    define member: [user, group#member]

type serviceaccount

type role
  relations
    define assignee: [user, group#member, serviceaccount]
    define parent_role: [role]
    define has_permission: assignee or has_permission from parent_role

type permission
  relations
    define granted_by: [role#has_permission]

type scope
  relations
    define parent: [scope]
    
    # RÃ´les de base (fixes)
    define owner: [user, group#member, serviceaccount] or owner from parent
    define contributor: [user, group#member, serviceaccount] or contributor from parent or owner
    define reader: [user, group#member, serviceaccount] or reader from parent or contributor
    
    # RÃ´les custom
    define custom_role: [role#assignee]
    
    # Permissions granulaires (resource:action)
    define can_read: reader or custom_role
    define can_write: contributor or custom_role
    define can_delete: owner
    define can_manage: owner
    define can_delegate: owner
```

## TABLE AUDIT (PostgreSQL)

```sql
-- authorization/infrastructure/migrations/001_create_audit_table.sql
CREATE TABLE authorization_audit (
    id BIGSERIAL PRIMARY KEY,
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    tenant_id VARCHAR(100) NOT NULL,
    operation VARCHAR(50) NOT NULL,  -- 'ASSIGN', 'REVOKE', 'CREATE_SCOPE', 'CREATE_ROLE', etc.
    principal_id UUID NOT NULL,       -- Qui a fait l'action
    target_principal_id UUID,         -- Sur qui
    role VARCHAR(100),
    scope TEXT,
    expires_at TIMESTAMPTZ,           -- Si expiration
    details JSONB,
    correlation_id UUID,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_audit_tenant ON authorization_audit(tenant_id);
CREATE INDEX idx_audit_timestamp ON authorization_audit(timestamp);
CREATE INDEX idx_audit_principal ON authorization_audit(principal_id);
CREATE INDEX idx_audit_operation ON authorization_audit(operation);
```

## DOCKER COMPOSE (DEV)

```yaml
# authorization/docker-compose.yml
services:
  openfga:
    image: openfga/openfga:latest
    ports:
      - "8080:8080"   # HTTP API
      - "8081:8081"   # gRPC
      - "3000:3000"   # Playground
    environment:
      - OPENFGA_DATASTORE_ENGINE=memory  # Ou postgres pour persistance
    command: run

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

## TESTS

```csharp
// Tests d'intÃ©gration avec OpenFGA
[Fact]
public async Task Check_WithDirectAssignment_ReturnsAllowed()
{
    // Arrange
    var userId = Guid.NewGuid();
    var scope = Scope.Parse("api.llmproxy.com/organizations/org-123");
    
    await _openFgaService.WriteTuplesAsync([
        TupleBuilder.UserAssignment(userId, "contributor", scope)
    ]);
    
    // Act
    var allowed = await _openFgaService.CheckAsync(
        $"user:{userId}",
        "can_write",
        $"scope:{scope.Path}");
    
    // Assert
    allowed.Should().BeTrue();
}

[Fact]
public async Task Check_WithInheritedPermission_ReturnsAllowed()
{
    // Arrange
    var userId = Guid.NewGuid();
    var parentScope = Scope.Parse("api.llmproxy.com/organizations/org-123");
    var childScope = Scope.Parse("api.llmproxy.com/organizations/org-123/tenants/tenant-456");
    
    await _openFgaService.WriteTuplesAsync([
        TupleBuilder.ScopeParent(childScope, parentScope),
        TupleBuilder.UserAssignment(userId, "owner", parentScope)
    ]);
    
    // Act
    var allowed = await _openFgaService.CheckAsync(
        $"user:{userId}",
        "can_delete",
        $"scope:{childScope.Path}");
    
    // Assert
    allowed.Should().BeTrue();  // Inherited from parent
}

[Fact]
public async Task Check_WithGroupMembership_ReturnsAllowed()
{
    // Arrange
    var userId = Guid.NewGuid();
    var groupId = Guid.NewGuid();
    var scope = Scope.Parse("api.llmproxy.com");
    
    await _openFgaService.WriteTuplesAsync([
        TupleBuilder.GroupMembership(userId, groupId),
        TupleBuilder.GroupAssignment(groupId, "reader", scope)
    ]);
    
    // Act
    var allowed = await _openFgaService.CheckAsync(
        $"user:{userId}",
        "can_read",
        $"scope:{scope.Path}");
    
    // Assert
    allowed.Should().BeTrue();  // Via group membership
}
```

## CRITÃˆRES DE SUCCÃˆS

- [ ] Projet crÃ©Ã© dans `authorization/src/Authorization.Infrastructure/`
- [ ] OpenFgaService implÃ©mentÃ© avec toutes les mÃ©thodes
- [ ] TenantStoreResolver pour multi-tenant (1 store/tenant)
- [ ] TupleBuilder pour construction simplifiÃ©e des tuples
- [ ] PermissionCacheService avec Redis
- [ ] AuditRepository avec PostgreSQL (table audit)
- [ ] Migration SQL pour table audit
- [ ] HealthCheck OpenFGA + PostgreSQL
- [ ] ModÃ¨le d'autorisation `.fga` enrichi (custom roles, permissions)
- [ ] docker-compose.yml pour dev (OpenFGA + Redis + PostgreSQL)
- [ ] Tests d'intÃ©gration OpenFGA
- [ ] Build : 0 erreurs, 0 warnings

## ESTIMATION

**Effort** : 14h (+6h vs initial)
**ComplexitÃ©** : Haute

**DÃ©tail** :
- OpenFGA Service (multi-tenant) : 6h
- PostgreSQL Audit : 4h
- Redis Cache : 2h
- Tests : 2h

## RÃ‰FÃ‰RENCES

- [OpenFGA .NET SDK](https://github.com/openfga/dotnet-sdk)
- [OpenFGA Modeling Guide](https://openfga.dev/docs/modeling)
- [ADR-060](../docs/adr/060-authorization-azure-rbac-style.adr.md)
