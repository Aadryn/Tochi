# T√¢che 067.8 - Authorization Tests Complets

## PRIORIT√â
üü° **P3 - MOYENNE** (D√©pend de 067.1-067.7)

## OBJECTIF

Impl√©menter une suite de tests compl√®te pour l'application Authorization :
- Tests unitaires (Domain, Application)
- Tests d'int√©gration (Infrastructure, OpenFGA)
- Tests de bout en bout (API)
- Couverture > 80%

## D√âPENDANCES

- ‚úÖ **067.1** - Domain Layer
- ‚úÖ **067.2** - Infrastructure Layer
- ‚úÖ **067.3** - Application Layer
- ‚úÖ **067.4** - API Layer
- ‚úÖ **067.5** - IDP Integration
- ‚úÖ **067.6** - Backend SDK
- ‚úÖ **067.7** - Cleanup Job

## STRUCTURE DE FICHIERS

```
authorization/tests/
‚îú‚îÄ‚îÄ Authorization.Domain.Tests/
‚îÇ   ‚îú‚îÄ‚îÄ Authorization.Domain.Tests.csproj
‚îÇ   ‚îú‚îÄ‚îÄ ValueObjects/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PrincipalIdTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ScopeTests.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PrincipalTypeTests.cs
‚îÇ   ‚îî‚îÄ‚îÄ DTOs/
‚îÇ       ‚îî‚îÄ‚îÄ CheckPermissionRequestTests.cs
‚îÇ
‚îú‚îÄ‚îÄ Authorization.Application.Tests/
‚îÇ   ‚îú‚îÄ‚îÄ Authorization.Application.Tests.csproj
‚îÇ   ‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthorizationServiceTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RoleAssignmentServiceTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DelegationServiceTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CustomRoleServiceTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GroupServiceTests.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ScopeServiceTests.cs
‚îÇ   ‚îî‚îÄ‚îÄ Validation/
‚îÇ       ‚îú‚îÄ‚îÄ DelegationValidatorTests.cs
‚îÇ       ‚îî‚îÄ‚îÄ DuplicateCheckerTests.cs
‚îÇ
‚îú‚îÄ‚îÄ Authorization.Infrastructure.Tests/
‚îÇ   ‚îú‚îÄ‚îÄ Authorization.Infrastructure.Tests.csproj
‚îÇ   ‚îú‚îÄ‚îÄ OpenFga/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OpenFgaServiceTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TupleBuilderTests.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TenantStoreResolverTests.cs
‚îÇ   ‚îú‚îÄ‚îÄ Caching/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PermissionCacheServiceTests.cs
‚îÇ   ‚îú‚îÄ‚îÄ Audit/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ AuditRepositoryTests.cs
‚îÇ   ‚îî‚îÄ‚îÄ Idp/
‚îÇ       ‚îú‚îÄ‚îÄ AzureAdClientTests.cs
‚îÇ       ‚îú‚îÄ‚îÄ OktaClientTests.cs
‚îÇ       ‚îî‚îÄ‚îÄ KeycloakClientTests.cs
‚îÇ
‚îú‚îÄ‚îÄ Authorization.API.Tests/
‚îÇ   ‚îú‚îÄ‚îÄ Authorization.API.Tests.csproj
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CheckControllerTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AssignmentsControllerTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RolesControllerTests.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ScopesControllerTests.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GroupsControllerTests.cs
‚îÇ   ‚îî‚îÄ‚îÄ Integration/
‚îÇ       ‚îú‚îÄ‚îÄ AuthorizationApiTests.cs
‚îÇ       ‚îî‚îÄ‚îÄ WebApplicationFactory.cs
‚îÇ
‚îî‚îÄ‚îÄ Authorization.Integration.Tests/
    ‚îú‚îÄ‚îÄ Authorization.Integration.Tests.csproj
    ‚îú‚îÄ‚îÄ OpenFgaIntegrationTests.cs
    ‚îú‚îÄ‚îÄ EndToEndScenarios.cs
    ‚îî‚îÄ‚îÄ Fixtures/
        ‚îú‚îÄ‚îÄ OpenFgaFixture.cs
        ‚îî‚îÄ‚îÄ PostgresFixture.cs
```

## SC√âNARIOS DE TEST

### 1. Tests Unitaires Domain Layer

```csharp
// ValueObjects/ScopeTests.cs
public class ScopeTests
{
    [Theory]
    [InlineData("api.llmproxy.com")]
    [InlineData("api.llmproxy.com/organizations/org-123")]
    [InlineData("api.llmproxy.com/organizations/org-123/tenants/tenant-456")]
    public void Parse_ValidScope_ReturnsScope(string path)
    {
        // Act
        var scope = Scope.Parse(path);
        
        // Assert
        scope.Path.Should().Be(path);
    }
    
    [Theory]
    [InlineData("")]
    [InlineData(" ")]
    [InlineData("invalid scope with spaces")]
    [InlineData("http://not-allowed")]
    public void Parse_InvalidScope_ThrowsException(string path)
    {
        // Act & Assert
        Action act = () => Scope.Parse(path);
        act.Should().Throw<ArgumentException>();
    }
    
    [Fact]
    public void IsDescendantOf_ChildScope_ReturnsTrue()
    {
        // Arrange
        var parent = Scope.Parse("api.llmproxy.com/organizations/org-123");
        var child = Scope.Parse("api.llmproxy.com/organizations/org-123/tenants/tenant-456");
        
        // Act & Assert
        child.IsDescendantOf(parent).Should().BeTrue();
    }
    
    [Fact]
    public void GetParent_ReturnsParentScope()
    {
        // Arrange
        var scope = Scope.Parse("api.llmproxy.com/organizations/org-123/tenants/tenant-456");
        
        // Act
        var parent = scope.GetParent();
        
        // Assert
        parent.Should().NotBeNull();
        parent!.Path.Should().Be("api.llmproxy.com/organizations/org-123");
    }
}
```

### 2. Tests Unitaires Application Layer

```csharp
// Services/DelegationServiceTests.cs
public class DelegationServiceTests
{
    private readonly IOpenFgaService _openFga;
    private readonly DelegationService _sut;
    
    public DelegationServiceTests()
    {
        _openFga = Substitute.For<IOpenFgaService>();
        _sut = new DelegationService(_openFga);
    }
    
    [Theory]
    [InlineData("owner", "owner", true)]      // Owner peut assigner Owner
    [InlineData("owner", "contributor", true)] // Owner peut assigner Contributor
    [InlineData("owner", "reader", true)]      // Owner peut assigner Reader
    [InlineData("contributor", "reader", true)] // Contributor peut assigner Reader
    [InlineData("contributor", "contributor", true)] // Contributor peut assigner Contributor
    [InlineData("contributor", "owner", false)] // Contributor NE PEUT PAS assigner Owner
    [InlineData("reader", "reader", true)]     // Reader peut assigner Reader
    [InlineData("reader", "contributor", false)] // Reader NE PEUT PAS assigner Contributor
    public async Task ValidateDelegation_ChecksHierarchy(
        string callerRole, string targetRole, bool shouldSucceed)
    {
        // Arrange
        var callerId = PrincipalId.Create(Guid.NewGuid());
        var scope = Scope.Parse("api.llmproxy.com/organizations/org-123");
        
        _openFga.CheckAsync(Arg.Any<string>(), callerRole, Arg.Any<string>())
            .Returns(true);
        
        // Act
        Func<Task> act = () => _sut.ValidateDelegationAsync(callerId, targetRole, scope);
        
        // Assert
        if (shouldSucceed)
            await act.Should().NotThrowAsync();
        else
            await act.Should().ThrowAsync<DelegationForbiddenException>();
    }
}

// Services/RoleAssignmentServiceTests.cs
public class RoleAssignmentServiceTests
{
    [Fact]
    public async Task AssignAsync_DuplicateAssignment_ThrowsException()
    {
        // Arrange
        var openFga = Substitute.For<IOpenFgaService>();
        openFga.ReadAsync(Arg.Any<string>(), Arg.Any<string>(), Arg.Any<string>())
            .Returns([new TupleKey("user:123", "reader", "scope:test")]);
        
        var service = new RoleAssignmentService(openFga, ...);
        var request = new AssignRoleRequest(...);
        
        // Act & Assert
        await FluentActions.Invoking(() => service.AssignAsync(request, callerId))
            .Should().ThrowAsync<DuplicateAssignmentException>();
    }
    
    [Fact]
    public async Task AssignAsync_ScopeNotCreated_ThrowsException()
    {
        // Arrange
        var scopeService = Substitute.For<IScopeService>();
        scopeService.ExistsAsync(Arg.Any<Scope>())
            .Returns(false);
        
        var service = new RoleAssignmentService(..., scopeService);
        var request = new AssignRoleRequest(...);
        
        // Act & Assert
        await FluentActions.Invoking(() => service.AssignAsync(request, callerId))
            .Should().ThrowAsync<ScopeNotCreatedException>();
    }
    
    [Fact]
    public async Task AssignAsync_MultipleRolesOnSameScope_Allowed()
    {
        // Arrange
        var openFga = Substitute.For<IOpenFgaService>();
        openFga.ReadAsync(Arg.Any<string>(), "reader", Arg.Any<string>())
            .Returns([new TupleKey("user:123", "reader", "scope:test")]);
        openFga.ReadAsync(Arg.Any<string>(), "contributor", Arg.Any<string>())
            .Returns([]);  // No existing contributor role
        
        var service = new RoleAssignmentService(openFga, ...);
        var request = new AssignRoleRequest(..., Role: "contributor");
        
        // Act
        var result = await service.AssignAsync(request, callerId);
        
        // Assert - Should succeed because multi-roles are allowed
        result.Should().NotBeNull();
        result.Role.Should().Be("contributor");
    }
}
```

### 3. Tests d'Int√©gration OpenFGA

```csharp
// OpenFgaIntegrationTests.cs
[Collection("OpenFGA")]
public class OpenFgaIntegrationTests : IAsyncLifetime
{
    private readonly OpenFgaFixture _fixture;
    private IOpenFgaService _sut = null!;
    
    public OpenFgaIntegrationTests(OpenFgaFixture fixture)
    {
        _fixture = fixture;
    }
    
    public async Task InitializeAsync()
    {
        _sut = await _fixture.CreateServiceAsync();
    }
    
    [Fact]
    public async Task Check_DirectAssignment_ReturnsAllowed()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var scope = Scope.Parse("api.llmproxy.com/organizations/org-123");
        
        await _sut.WriteTuplesAsync([
            TupleBuilder.UserAssignment(userId, "contributor", scope)
        ]);
        
        // Act
        var allowed = await _sut.CheckAsync(
            $"user:{userId}", "can_write", $"scope:{scope.Path}");
        
        // Assert
        allowed.Should().BeTrue();
    }
    
    [Fact]
    public async Task Check_InheritedFromParent_ReturnsAllowed()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var parentScope = Scope.Parse("api.llmproxy.com/organizations/org-123");
        var childScope = Scope.Parse("api.llmproxy.com/organizations/org-123/tenants/tenant-456");
        
        await _sut.WriteTuplesAsync([
            TupleBuilder.ScopeParent(childScope, parentScope),
            TupleBuilder.UserAssignment(userId, "owner", parentScope)
        ]);
        
        // Act
        var allowed = await _sut.CheckAsync(
            $"user:{userId}", "can_delete", $"scope:{childScope.Path}");
        
        // Assert
        allowed.Should().BeTrue();
    }
    
    [Fact]
    public async Task Check_ViaGroupMembership_ReturnsAllowed()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var groupId = Guid.NewGuid();
        var scope = Scope.Parse("api.llmproxy.com");
        
        await _sut.WriteTuplesAsync([
            TupleBuilder.GroupMembership(userId, groupId),
            TupleBuilder.GroupAssignment(groupId, "reader", scope)
        ]);
        
        // Act
        var allowed = await _sut.CheckAsync(
            $"user:{userId}", "can_read", $"scope:{scope.Path}");
        
        // Assert
        allowed.Should().BeTrue();
    }
    
    [Fact]
    public async Task Revoke_ImmediateEffect_PermissionDenied()
    {
        // Arrange
        var userId = Guid.NewGuid();
        var scope = Scope.Parse("api.llmproxy.com");
        
        await _sut.WriteTuplesAsync([
            TupleBuilder.UserAssignment(userId, "reader", scope)
        ]);
        
        // V√©rifier permission initiale
        var beforeRevoke = await _sut.CheckAsync(
            $"user:{userId}", "can_read", $"scope:{scope.Path}");
        beforeRevoke.Should().BeTrue();
        
        // Act - R√©voquer
        await _sut.DeleteTuplesAsync([
            TupleBuilder.UserAssignment(userId, "reader", scope)
        ]);
        
        // Assert - R√©vocation imm√©diate
        var afterRevoke = await _sut.CheckAsync(
            $"user:{userId}", "can_read", $"scope:{scope.Path}");
        afterRevoke.Should().BeFalse();
    }
}
```

### 4. Tests End-to-End API

```csharp
// Integration/AuthorizationApiTests.cs
public class AuthorizationApiTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly HttpClient _client;
    
    public AuthorizationApiTests(WebApplicationFactory<Program> factory)
    {
        _client = factory.CreateClient();
    }
    
    [Fact]
    public async Task Check_WithValidToken_ReturnsResult()
    {
        // Arrange
        var request = new
        {
            principalId = Guid.NewGuid(),
            permission = "can_read",
            scope = "api.llmproxy.com/organizations/org-123"
        };
        
        // Act
        var response = await _client.PostAsJsonAsync("/api/v1/check", request);
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.OK);
        var result = await response.Content.ReadFromJsonAsync<CheckResponse>();
        result.Should().NotBeNull();
    }
    
    [Fact]
    public async Task Assign_WithDelegationViolation_Returns403()
    {
        // Arrange - Caller is Reader, trying to assign Owner
        var request = new
        {
            principalId = Guid.NewGuid(),
            principalType = "User",
            role = "owner",  // Reader cannot assign Owner
            scope = "api.llmproxy.com/organizations/org-123"
        };
        
        // Act
        var response = await _client.PostAsJsonAsync("/api/v1/assignments", request);
        
        // Assert
        response.StatusCode.Should().Be(HttpStatusCode.Forbidden);
    }
    
    [Fact]
    public async Task CreateScope_ThenAssign_Works()
    {
        // Arrange
        var scopePath = $"api.llmproxy.com/organizations/org-{Guid.NewGuid():N}";
        
        // Act 1 - Cr√©er le scope
        var scopeResponse = await _client.PostAsJsonAsync("/api/v1/scopes", new { path = scopePath });
        scopeResponse.StatusCode.Should().Be(HttpStatusCode.Created);
        
        // Act 2 - Assigner un r√¥le
        var assignResponse = await _client.PostAsJsonAsync("/api/v1/assignments", new
        {
            principalId = Guid.NewGuid(),
            principalType = "User",
            role = "reader",
            scope = scopePath
        });
        
        // Assert
        assignResponse.StatusCode.Should().Be(HttpStatusCode.Created);
    }
}
```

## CRIT√àRES DE SUCC√àS

- [ ] Tests Domain Layer (Value Objects, DTOs) > 90%
- [ ] Tests Application Layer (Services) > 85%
- [ ] Tests Infrastructure Layer (OpenFGA, Cache, Audit) > 80%
- [ ] Tests API Layer (Controllers) > 80%
- [ ] Tests d'int√©gration OpenFGA (sc√©narios RBAC)
- [ ] Tests E2E API (happy path + erreurs)
- [ ] Couverture globale > 80%
- [ ] Tous les tests passent (0 √©checs)
- [ ] CI/CD compatible

## ESTIMATION

**Effort** : 10h
**Complexit√©** : Haute

**D√©tail** :
- Tests Domain : 1h
- Tests Application : 4h
- Tests Infrastructure : 3h
- Tests API + E2E : 2h

## R√âF√âRENCES

- [xUnit Documentation](https://xunit.net/docs/getting-started/netcore/cmdline)
- [NFluent](https://github.com/tpierrain/NFluent)
- [NSubstitute](https://nsubstitute.github.io/)
- [ADR-060](../docs/adr/060-authorization-azure-rbac-style.adr.md)
