# T√¢che 067.4 - Authorization.API (API Autonome)

## PRIORIT√â
üî¥ **P1 - CRITIQUE** (D√©pend de 067.3)

## OBJECTIF

Cr√©er l'API Authorization autonome exposant les endpoints REST pour :
- Gestion des r√¥les (CRUD)
- Gestion des assignments (attribution/r√©vocation)
- Gestion des principals (users, groups, service accounts)
- V√©rification des permissions
- Calcul des permissions effectives

## IMPL√âMENTATION

### Structure du Projet

```
src/Presentation/LLMProxy.Authorization.API/
‚îú‚îÄ‚îÄ LLMProxy.Authorization.API.csproj
‚îú‚îÄ‚îÄ Program.cs
‚îú‚îÄ‚îÄ appsettings.json
‚îú‚îÄ‚îÄ appsettings.Development.json
‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îî‚îÄ‚îÄ V1/
‚îÇ       ‚îú‚îÄ‚îÄ RolesController.cs
‚îÇ       ‚îú‚îÄ‚îÄ AssignmentsController.cs
‚îÇ       ‚îú‚îÄ‚îÄ PrincipalsController.cs
‚îÇ       ‚îú‚îÄ‚îÄ GroupsController.cs
‚îÇ       ‚îú‚îÄ‚îÄ CheckController.cs
‚îÇ       ‚îî‚îÄ‚îÄ ScopesController.cs
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îú‚îÄ‚îÄ Requests/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateRoleRequest.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UpdateRoleRequest.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateAssignmentRequest.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CreateGroupRequest.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AddGroupMemberRequest.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CheckPermissionRequest.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ BatchCheckRequest.cs
‚îÇ   ‚îî‚îÄ‚îÄ Responses/
‚îÇ       ‚îú‚îÄ‚îÄ RoleResponse.cs
‚îÇ       ‚îú‚îÄ‚îÄ AssignmentResponse.cs
‚îÇ       ‚îú‚îÄ‚îÄ PrincipalResponse.cs
‚îÇ       ‚îú‚îÄ‚îÄ GroupResponse.cs
‚îÇ       ‚îú‚îÄ‚îÄ PermissionCheckResponse.cs
‚îÇ       ‚îú‚îÄ‚îÄ EffectivePermissionsResponse.cs
‚îÇ       ‚îî‚îÄ‚îÄ ScopeHierarchyResponse.cs
‚îú‚îÄ‚îÄ Middleware/
‚îÇ   ‚îú‚îÄ‚îÄ RequestLoggingMiddleware.cs
‚îÇ   ‚îî‚îÄ‚îÄ ErrorHandlingMiddleware.cs
‚îú‚îÄ‚îÄ Extensions/
‚îÇ   ‚îî‚îÄ‚îÄ ServiceCollectionExtensions.cs
‚îú‚îÄ‚îÄ HealthChecks/
‚îÇ   ‚îú‚îÄ‚îÄ DatabaseHealthCheck.cs
‚îÇ   ‚îî‚îÄ‚îÄ OpenFgaHealthCheck.cs
‚îî‚îÄ‚îÄ OpenApi/
    ‚îî‚îÄ‚îÄ AuthorizationApiDocumentation.cs
```

### Endpoints REST

```http
# ============================================
# GESTION DES R√îLES
# ============================================

# Liste tous les r√¥les (builtin + custom)
GET /api/v1/roles
Query: ?includeBuiltin=true&pageSize=20&pageNumber=1

# D√©tail d'un r√¥le
GET /api/v1/roles/{roleId}

# Cr√©er un r√¥le custom
POST /api/v1/roles
Body: {
  "name": "Custom.DataScientist",
  "description": "Acc√®s lecture aux providers et stats",
  "permissions": [
    { "action": "read", "resourceType": "provider" },
    { "action": "read", "resourceType": "stats" },
    { "action": "export", "resourceType": "stats" }
  ],
  "assignableScopes": ["tenant", "resource"]
}

# Modifier un r√¥le custom (builtin = readonly)
PUT /api/v1/roles/{roleId}

# Supprimer un r√¥le custom
DELETE /api/v1/roles/{roleId}

# ============================================
# GESTION DES ASSIGNMENTS
# ============================================

# Liste les assignments (filtrable par ObjectId)
GET /api/v1/assignments
Query: ?principalId={objectId}&scopeType={type}&scopeId={id}&roleId={id}

# D√©tail d'un assignment
GET /api/v1/assignments/{assignmentId}

# Cr√©er un assignment (principalId = ObjectId GUID)
POST /api/v1/assignments
Body: {
  "principalId": "550e8400-e29b-41d4-a716-446655440000",  // ObjectId (GUID)
  "roleId": "Tenant.Operator",
  "scope": {
    "type": "tenant",
    "id": "tenant-123",
    "organizationId": "org-456"
  },
  "expiresAt": "2025-12-31T23:59:59Z"  // Optionnel
}

# R√©voquer un assignment
DELETE /api/v1/assignments/{assignmentId}

# ============================================
# GESTION DES PRINCIPALS (ObjectId = GUID)
# ============================================

# Liste les principals
GET /api/v1/principals
Query: ?type=user|group|service_account&search={term}

# D√©tail d'un principal par son ObjectId
GET /api/v1/principals/{objectId}

# Recherche d'un principal par ExternalId (email, nom)
GET /api/v1/principals/by-external-id?externalId={email}&type=user

# Synchroniser un principal depuis IDP externe (retourne l'ObjectId)
POST /api/v1/principals/sync
Body: {
  "type": "user",
  "externalId": "john@example.com",
  "displayName": "John Doe",
  "email": "john@example.com"
}
Response: {
  "objectId": "550e8400-e29b-41d4-a716-446655440000",
  "type": "user",
  "externalId": "john@example.com",
  "displayName": "John Doe"
}

# ============================================
# GESTION DES GROUPES
# ============================================

# Liste les groupes
GET /api/v1/groups

# Cr√©er un groupe (retourne l'ObjectId)
POST /api/v1/groups
Body: {
  "name": "data-team",
  "displayName": "Data Science Team",
  "description": "√âquipe data science"
}
Response: {
  "objectId": "661e9500-f30c-52e5-b827-557766551111",
  "name": "data-team",
  "displayName": "Data Science Team"
}

# D√©tail d'un groupe avec ses membres (ObjectIds)
GET /api/v1/groups/{objectId}

# Ajouter un membre au groupe (via ObjectId du membre)
POST /api/v1/groups/{groupObjectId}/members
Body: {
  "memberObjectId": "550e8400-e29b-41d4-a716-446655440000"
}

# Retirer un membre du groupe
DELETE /api/v1/groups/{groupObjectId}/members/{memberObjectId}

# ============================================
# V√âRIFICATION D'AUTORISATION (utilise ObjectId)
# ============================================

# V√©rifier une permission unique
POST /api/v1/check
Body: {
  "principalId": "550e8400-e29b-41d4-a716-446655440000",  // ObjectId (GUID)
  "action": "write",
  "resourceType": "provider",
  "scope": {
    "type": "resource",
    "id": "provider-789",
    "tenantId": "tenant-123",
    "organizationId": "org-456"
  }
}
Response: {
  "allowed": true,
  "principalObjectId": "550e8400-e29b-41d4-a716-446655440000",
  "reason": "Role 'Tenant.Operator' on scope 'tenant:tenant-123'",
  "evaluationTimeMs": 12
}

# V√©rification batch (jusqu'√† 100 checks)
POST /api/v1/check/batch
Body: {
  "checks": [
    { "principalId": "550e8400-...", "action": "...", "resourceType": "...", "scope": {...} },
    { ... }
  ]
}

# Permissions effectives d'un principal (par ObjectId)
GET /api/v1/principals/{objectId}/effective-permissions
Query: ?scopeType={type}&scopeId={id}
Response: {
  "principalObjectId": "550e8400-e29b-41d4-a716-446655440000",
  "effectivePermissions": [
    {
      "action": "*",
      "resourceType": "*",
      "scope": "/organizations/org-456/tenants/tenant-123",
      "grantedBy": {
        "roleId": "Tenant.Admin",
        "assignmentId": "assign-001"
      }
    }
  ]
}

# ============================================
# HI√âRARCHIE DES SCOPES
# ============================================

# Arborescence des scopes
GET /api/v1/scopes
Response: {
  "platform": {
    "id": "/",
    "children": [
      {
        "type": "organization",
        "id": "org-456",
        "name": "Acme Corp",
        "children": [...]
      }
    ]
  }
}

# Enfants d'un scope
GET /api/v1/scopes/{scopeType}/{scopeId}/children

# Assignments sur un scope (avec h√©ritage)
GET /api/v1/scopes/{scopeType}/{scopeId}/assignments
Query: ?includeInherited=true
```

### Configuration

```json
// appsettings.json
{
  "Authorization": {
    "Database": {
      "ConnectionString": "${AUTHORIZATION_DB_CONNECTION}",
      "Schema": "authorization"
    },
    "Cache": {
      "Provider": "Redis",
      "ConnectionString": "${REDIS_CONNECTION}",
      "DefaultExpirationMinutes": 5,
      "KeyPrefix": "authz:"
    },
    "OpenFga": {
      "Enabled": true,
      "ApiUrl": "${OPENFGA_API_URL}",
      "StoreId": "${OPENFGA_STORE_ID}",
      "SyncEnabled": true
    },
    "Telemetry": {
      "ServiceName": "authorization-api",
      "TracingEnabled": true,
      "MetricsEnabled": true
    }
  }
}
```

### Program.cs

```csharp
var builder = WebApplication.CreateBuilder(args);

// Services
builder.Services.AddAuthorizationDomain();
builder.Services.AddAuthorizationInfrastructure(builder.Configuration);
builder.Services.AddAuthorizationApplication();

// API
builder.Services.AddControllers();
builder.Services.AddApiVersioning(options =>
{
    options.DefaultApiVersion = new ApiVersion(1, 0);
    options.AssumeDefaultVersionWhenUnspecified = true;
    options.ReportApiVersions = true;
});

// OpenAPI
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "LLMProxy Authorization API",
        Version = "v1",
        Description = "API de gestion des autorisations style Azure RBAC"
    });
});

// Health Checks
builder.Services.AddHealthChecks()
    .AddCheck<DatabaseHealthCheck>("database")
    .AddCheck<OpenFgaHealthCheck>("openfga")
    .AddCheck<RedisHealthCheck>("redis");

// Telemetry
builder.Services.AddOpenTelemetry()
    .WithTracing(...)
    .WithMetrics(...);

var app = builder.Build();

// Middleware
app.UseRequestLogging();
app.UseErrorHandling();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();
app.MapHealthChecks("/health");
app.MapHealthChecks("/health/ready", new HealthCheckOptions
{
    Predicate = check => check.Tags.Contains("ready")
});

app.Run();
```

## CRIT√àRES DE SUCC√àS

- [ ] API autonome d√©ployable s√©par√©ment
- [ ] Tous les endpoints impl√©ment√©s
- [ ] Authentification JWT configur√©e
- [ ] Documentation OpenAPI compl√®te
- [ ] Health checks fonctionnels
- [ ] M√©triques Prometheus expos√©es
- [ ] Tracing OpenTelemetry actif
- [ ] Tests d'int√©gration API (>80% endpoints)
- [ ] Dockerfile + docker-compose
- [ ] Build : 0 erreurs, 0 warnings

## ESTIMATION

**Effort** : 12h
**Complexit√©** : Haute

## D√âPENDANCES

- 067.1, 067.2, 067.3 compl√©t√©es

## TRACKING
